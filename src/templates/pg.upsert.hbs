WITH
  updated AS (
    UPDATE {{escape table}}
    SET {{assignments}}
    WHERE {{where}}
    RETURNING {{returning}}
  ),
  inserted AS (
    INSERT INTO {{escape table}} ({{columns}})
    SELECT {{values}}
    WHERE NOT EXISTS (SELECT * FROM updated)
    RETURNING {{returning}}
  )
SELECT * FROM inserted
UNION ALL
SELECT * FROM updated
